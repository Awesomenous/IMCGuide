# Processing Images For Cellpose

## Removing Outliers From Images

The next step involves removing outlier pixels from each image channel in your full stack images. This is done by the ImageJ script `1.5 RemoveOutliers.ijm`, which uses the built-in `Remove Outliers...` function. You can read more about the function [here](https://imagej.net/ij/docs/menus/process.html#:~:text=Remove%20Outliers,%2C%20i.e.%2C%20in%20pixels). 

After opening the script, remember to **set your analysis folder directory** before running it. Again, **Windows** users should ensure that they use **forward slashes** instead of back slashes in their directory path. 

```{java eval=FALSE}
// Set your 'analysis' folder directory
dir = "IMC/analysis";
```

The modified images are saved to the **same** `analysis/1c_full_images` folder, and will simply **replace** the old images. 

## Generating Images for Cellpose 

In this step, we generate composite images to use for cell segmentation in Cellpose later on. This is done by the ImageJ script `2 ExtractForCellPose.ijm`, which generates image stacks containing 2 channels: 1 for the cell nuclei (in **blue**) and 1 for the rest of the cell body (in **green**). The cell body channel is generated by taking an 'Average Intensity' projection of all the channels labelled `1` in the 'Segment' column of `panel.csv`. 

Open the ImageJ script `2 ExtractForCellPose.ijm` and **change all required variables** there before running it. `square_size` controls the size of the square (in pixels) used to generate random crops of each image - these are used in Cellpose later to train the segmentation model. 

```{java eval=FALSE}
// Set your 'analysis' folder directory
dir = "IMC/analysis";
// Set your 'panel.csv' file directory
panelDir = "IMC/raw/panel.csv";
// Change this to what you call your nuclei stain under the 'Target' column in 'panel.csv'. 
// This usually corresponds to the Ir191 or Ir193 Metal tags. 
dna = "DNA";
// Size (in pixels) of the square for cropping
square_size = 200;
```

The full images are saved under `analysis/2a_cellpose_full`, and the cropped areas are saved to `analysis/2b_cropped_images`.

